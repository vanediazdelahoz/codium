services:
  postgres:
    image: postgres:16-alpine
    container_name: codium-postgres
    environment:
      POSTGRES_USER: codium
      POSTGRES_PASSWORD: codium_password
      POSTGRES_DB: codium_db
    ports: ["5432:5432"]
    volumes: ["postgres_data:/var/lib/postgresql/data"]
    networks: ["codium-network"]
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U codium"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: codium-redis
    ports: ["6379:6379"]
    volumes: ["redis_data:/data"]
    networks: ["codium-network"]
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  api:
    build:
      context: .
      dockerfile: Dockerfile.dev
    env_file: ./.env
    container_name: codium-api
    ports: ["3000:3000"]
    volumes:
      - .:/app
      - /app/node_modules
    depends_on:
      postgres: { condition: service_healthy }
      redis: { condition: service_healthy }
    networks: ["codium-network"]
    restart: unless-stopped
    command: sh -c "pnpm exec prisma generate && pnpm exec prisma migrate deploy && pnpm exec prisma db seed && pnpm run start:dev"

  worker-python:
    build:
      context: .
      dockerfile: ./workers/python-worker/Dockerfile
    environment:
      REDIS_HOST: redis
      REDIS_PORT: 6379
      DATABASE_URL: ${DATABASE_URL}
    depends_on:
      postgres: { condition: service_healthy }
      redis: { condition: service_healthy }
    networks: ["codium-network"]
    restart: unless-stopped
    # Basic runtime limits to reduce blast radius for execution workers
    mem_limit: 512m
    ulimits:
      nproc: 200
      nofile: 1048576
    command: sh -c "npx prisma generate && npm start"

  worker-java:
    build:
      context: .
      dockerfile: ./workers/java-worker/Dockerfile
    environment:
      REDIS_HOST: redis
      REDIS_PORT: 6379
      DATABASE_URL: ${DATABASE_URL}
    depends_on:
      postgres: { condition: service_healthy }
      redis: { condition: service_healthy }
    networks: ["codium-network"]
    restart: unless-stopped
    mem_limit: 512m
    ulimits:
      nproc: 200
      nofile: 1048576
    command: sh -c "npx prisma generate && npm start"

  worker-nodejs:
    build:
      context: .
      dockerfile: ./workers/nodejs-worker/Dockerfile
    environment:
      REDIS_HOST: redis
      REDIS_PORT: 6379
      DATABASE_URL: ${DATABASE_URL}
    depends_on:
      postgres: { condition: service_healthy }
      redis: { condition: service_healthy }
    networks: ["codium-network"]
    restart: unless-stopped
    mem_limit: 512m
    ulimits:
      nproc: 200
      nofile: 1048576
    command: sh -c "npx prisma generate && npm start"

  worker-cpp:
    build:
      context: .
      dockerfile: ./workers/cpp-worker/Dockerfile
    environment:
      REDIS_HOST: redis
      REDIS_PORT: 6379
      DATABASE_URL: ${DATABASE_URL}
    depends_on:
      postgres: { condition: service_healthy }
      redis: { condition: service_healthy }
    networks: ["codium-network"]
    restart: unless-stopped
    mem_limit: 1024m
    ulimits:
      nproc: 200
      nofile: 1048576
    command: sh -c "npx prisma generate && npm start"

networks:
  codium-network:
    driver: bridge

volumes:
  postgres_data:
  redis_data: